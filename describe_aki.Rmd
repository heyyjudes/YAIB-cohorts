---
title: "Description of ICU mortality data"
output: html_document
date: "2022-09-27"
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}

library(data.table)
library(tidyverse)
library(gtsummary)
library(testthat)

conf <- ricu:::read_json("config.json")
srcs <- c("miiv", "mimic", "eicu", "hirid", "aumc")

knitr::opts_chunk$set(echo=TRUE)

```

```{r load}

load_data <- function(src) {
  path <- file.path(conf$output_dir, "aki", src)
  list(
    outc = arrow::read_parquet(file.path(path, "outc.parquet")),
    dyn = arrow::read_parquet(file.path(path, "dyn.parquet")),
    sta = arrow::read_parquet(file.path(path, "sta.parquet"))
  )
}

data <- srcs %>% 
  set_names() %>% 
  map(load_data)

static <- map(data, "sta") %>% bind_rows(.id="src")
dyn <- map(data, "dyn") %>% bind_rows(.id="src")
dyn[, time := ricu:::re_time(time, hours(1L))]
outc <- map(data, "outc") %>% bind_rows(.id="src")
outc[, time := ricu:::re_time(time, hours(1L))]
outc[, stay_id := as.character(stay_id)]

outc_bin <- outc[, .(
    label = max(label, na.rm = TRUE), 
    onset = if(any(label, na.rm = TRUE)) max(time[ricu::is_true(label)]) - 6 else NA_real_
  ), 
  by = c("src", "stay_id")
]

# TODO: Fix time to hours

```

```{r sanity-check}

expect_equal(nrow(static), nrow(distinct(outc[, .(src, stay_id)])))                     # every patient has some static data
expect_equal(nrow(distinct(static[, .(src, stay_id)])), nrow(distinct(dyn[, .(src, stay_id)])))  # every patient has some dynamic data
expect_equal(max(count(dyn, src, stay_id)$n), 169)       # no more than 193 time steps (1 + 7 * 24 + 24)

```

```{r describe-static}

map(data, ~ summary(.$sta))

tbl_strata(static, strata="src", tbl_summary)

ghist <- ggplot(NULL, aes(fill=src)) + 
  geom_histogram(
    aes(y=..count../tapply(..count..,..PANEL..,sum)[..PANEL..]), 
    position='identity', 
    alpha=0.3
  ) + 
  facet_wrap(. ~ src) + 
  theme_bw()            
            
ghist %+% static %+% aes(x=age) + labs(title="Age")
ghist %+% static %+% aes(x=height) + labs(title="Height")
ghist %+% static %+% aes(x=weight) + labs(title="Weight")
            
```

See description of mortality data for interpretation of the differences between databases.


```{r describe-outcome}

tbl_summary(outc_bin %>% select(-stay_id), by="src")

gbar <- ggplot(NULL, aes(fill=src)) + 
  geom_bar(
    aes(y = ..count../tapply(..count..,..PANEL..,sum)[..PANEL..]), 
    position='identity', 
    alpha=0.3, 
    width=1
  ) + 
  facet_wrap(. ~ src, ) + 
  theme_bw()          

gbar %+% outc_bin %+% aes(x=onset) + labs(title="Onset of AKI")
gbar %+% outc_bin[onset <= 36] %+% aes(x=onset) + labs(title="Onset of AKI in first 24h")

outc_bin[!is.na(onset), .(onset = pmin(onset, 24L))] %>% table()

outc %>% 
  group_by(src) %>% 
  summarise(p = mean(label))

```

Note that in the above plot, onset at hour 6 is overrepresented because it includes all patients with sepsis onset in hours 4-6 (the exact onset cannot be determined retrospectively from the labelled outcome for those patients). Fever patients from eICU and HiRID fall into that group, presumably because less (or in the case of HiRID no) information prior to ICU admission is available in these datasets.

```{r describe-followup}

fu <- outc_[, .SD[.N], by = stay_id]

gbar %+% fu %+% aes(x=as.numeric(time), fill = label) + labs(title="Follow-up by sepsis outcome")

```

The follow-up patterns across databases are pretty distinct. Across databases, there is a 24h cycle in terms of length of stay, with more patients discharged close to multiples of 24. In AUMC, eICU, and MIMIC, cases that are identified with sepsis early (hours 4-6) stay in ICU at least for another day (represented by almost no sepsis patients with less than 30 hours patients). This is not the case for HiRID, which has a bimodal distribution of follow-up times for early sepsis patients. While some show the same >24h behaviour as sepsis patients in other databases, there is also a substantial group that has a distribution comparable to that of non-sepsis patients. This suggests that due to the missing microbiology in HiRID, many non-septic patients with multiple antibiotics are mislabelled as septic.  
